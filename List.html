<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />
    <link rel="StyleSheet" href="StyleL.css" type="text/css" />

    <title>Users List</title>
  </head>
  <nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" id="companyname" href="#">Company Name</a>
    <button
      class="navbar-toggler"
      type="button"
      data-toggle="collapse"
      data-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent"
      aria-expanded="false"
      aria-label="Toggle navigation"
    >
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="nav-link" href="#">Home </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Profile</a>
        </li>
        <li class="nav-item dropdown">
          <a
            class="nav-link dropdown-toggle"
            href="#"
            id="navbarDropdown"
            role="button"
            data-toggle="dropdown"
            aria-haspopup="true"
            aria-expanded="false"
          >
            Menu
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            <a
              class="dropdown-item"
              data-toggle="modal"
              data-target="#staticBackdrop"
              href="#"
              >Add user</a
            >
            <div class="dropdown-divider"></div>
            <a
              class="dropdown-item"
              data-toggle="modal"
              data-target="#deleteModal"
              href="#"
              >Delete user</a
            >
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="#">Update user</a>
          </div>
        </li>
      </ul>
      <a class="btn btn-primary" id="logout" role="button">Log out</a>
    </div>
  </nav>
  <body>
    <!------------------- Scripts Config ---------------------------------------------->
    <script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-auth.js"></script>

    <script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-database.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
      integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
      integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
      integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
    <script>
      // Your web app's Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyDtEyb104TArxyc7hIKnYPrHeh5szPDmUU",
        authDomain: "parcial-1-clase-web.firebaseapp.com",
        databaseURL: "https://parcial-1-clase-web.firebaseio.com",
        projectId: "parcial-1-clase-web",
        storageBucket: "parcial-1-clase-web.appspot.com",
        messagingSenderId: "214864287638",
        appId: "1:214864287638:web:01b04423c8da79423cefb7",
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      //firebase.analytics();
    </script>
    <script>
      var emailaux, passaux, uidaux;
      firebase.auth().onAuthStateChanged(function (user) {
        if (user) {
          uid = firebase.auth().currentUser.uid;
          uidaux = uid;
          var cname = firebase.database().ref("users/" + uid + "/name");
          cname.on("value", function (snapshot) {
            document.getElementById("companyname").innerHTML = snapshot.val();
          });
          var opnum = firebase.database().ref("users/" + uid + "/operators");
          opnum.on("value", function (snapshot) {
            document.getElementById("opnumber").innerText =
              "Operators registered: " + snapshot.val();
          });
          var cmail = firebase.database().ref("users/" + uid + "/email");
          cmail.on("value", function (snapshot) {
            emailaux = snapshot.val();
          });
          var cpass = firebase.database().ref("users/" + uid + "/password");
          cpass.on("value", function (snapshot) {
            passaux = snapshot.val();
          });
        } else {
        }
      });
    </script>
    <script>
      $("#logout").click(function () {
        firebase
          .auth()
          .signOut()
          .then(function () {
            Swal.fire({
              title: "Are you sure?",
              icon: "warning",
              showCancelButton: true,
              confirmButtonColor: "#3085d6",
              cancelButtonColor: "#d33",
              confirmButtonText: "Yes, Log out!",
            }).then((result) => {
              if (result.value) {
                window.location = "index.html";
              }
            });
          })
          .catch(function (error) {
            Swal.fire({
              icon: "error",
              title: "Error to Log Out",
            });
          });
      });
      $(".modal").on("hidden.bs.modal", function (e) {
        $(this).removeData();
      });
    </script>
    <!------------------------End Script's ------------------------------------>
    <main role="main" class="container">
      <div class="d-flex align-items-center p-3 my-3 rounded shadow-sm">
        <img
          class="mr-3"
          src="assets/operadores.png"
          alt=""
          width="48"
          height="48"
        />
        <div class="lh-100">
          <h6 class="mb-0 lh-100">Company operators</h6>
          <small id="opnumber">Since 2011</small>
        </div>
      </div>
      <div id="userslist" class="my-3 p-3 bg-white rounded shadow-sm">
        <h6 class="border-bottom border-gray pb-2 mb-0">Users</h6>
        <div id="useritem" class="media text-muted pt-3">
          <svg
            class="bd-placeholder-img mr-2 rounded"
            width="32"
            height="32"
            xmlns="http://www.w3.org/2000/svg"
            preserveAspectRatio="xMidYMid slice"
            focusable="false"
            role="img"
            aria-label="Placeholder: 32x32"
          >
            <rect width="100%" height="100%" fill="#007bff" />
          </svg>
          <div
            class="media-body pb-3 mb-0 small lh-125 border-bottom border-gray"
          >
            <div
              class="d-flex justify-content-between align-items-center w-100"
            >
              <strong class="text-gray-dark item-user">Full Name</strong>
              <a href="results.html">See more</a>
            </div>
            <span class="d-block"
              >Lorem ipsum dolor sit amet, consectetur adipiscing elit.
              Phasellus sed leo vel libero hendrerit feugiat.</span
            >
          </div>
        </div>
        <div class="media text-muted pt-3">
          <svg
            class="bd-placeholder-img mr-2 rounded"
            width="32"
            height="32"
            xmlns="http://www.w3.org/2000/svg"
            preserveAspectRatio="xMidYMid slice"
            focusable="false"
            role="img"
            aria-label="Placeholder: 32x32"
          >
            <title>Placeholder</title>
            <rect width="100%" height="100%" fill="#007bff" />
            <text x="50%" y="50%" fill="#007bff" dy=".3em">32x32</text>
          </svg>
          <div
            class="media-body pb-3 mb-0 small lh-125 border-bottom border-gray"
          >
            <div
              class="d-flex justify-content-between align-items-center w-100"
            >
              <strong class="text-gray-dark">Full Name</strong>
              <a href="results.html">See more</a>
            </div>
            <span class="d-block"
              >Lorem ipsum dolor sit amet, consectetur adipiscing elit.
              Phasellus sed leo vel libero hendrerit feugiat.</span
            >
          </div>
        </div>
        <div class="media text-muted pt-3">
          <svg
            class="bd-placeholder-img mr-2 rounded"
            width="32"
            height="32"
            xmlns="http://www.w3.org/2000/svg"
            preserveAspectRatio="xMidYMid slice"
            focusable="false"
            role="img"
            aria-label="Placeholder: 32x32"
          >
            <title>Placeholder</title>
            <rect width="100%" height="100%" fill="#007bff" />
            <text x="50%" y="50%" fill="#007bff" dy=".3em">32x32</text>
          </svg>
          <div
            class="media-body pb-3 mb-0 small lh-125 border-bottom border-gray"
          >
            <div
              class="d-flex justify-content-between align-items-center w-100"
            >
              <strong class="text-gray-dark">Full Name</strong>
              <a href="results.html">See more</a>
            </div>
            <span class="d-block"
              >Lorem ipsum dolor sit amet, consectetur adipiscing elit.
              Phasellus sed leo vel libero hendrerit feugiat.</span
            >
          </div>
        </div>
      </div>
    </main>
    <!------------------------------ Register new user Modal popup ----------------------------->
    <div
      class="modal fade"
      id="staticBackdrop"
      data-backdrop="static"
      tabindex="-1"
      role="dialog"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropLabel">Add operator</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label for="formGroupExampleInput">Operator name</label>
                <input
                  type="text"
                  class="form-control"
                  id="opusername"
                  placeholder="User"
                />
              </div>
              <div class="form-group">
                <label for="formGroupExampleInput2">Operator email</label>
                <input
                  type="email"
                  class="form-control"
                  id="useremail"
                  placeholder="Email"
                />
              </div>
              <div class="form-group">
                <label for="formGroupExampleInput2">Operator Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="userpassword"
                  placeholder="Password"
                />
              </div>
              <div class="form-group">
                <label> Profile image</label>
                <div class="custom-file">
                  <input
                    type="file"
                    class="custom-file-input"
                    id="customFile"
                  />
                  <label class="custom-file-label" for="customFile"
                    >Choose file</label
                  >
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" id="registeruser" class="btn btn-primary">
              Submit
            </button>
          </div>
        </div>
      </div>
    </div>
    <!------------------------------ Delete user Modal popup ----------------------------------->
    <div
      class="modal fade"
      id="deleteModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Delete Operator</h5>
          </div>
          <div class="modal-body">
            <p>
              To delete de operator you may have access to the email and
              password.
            </p>
            <form>
              <div class="form-group">
              <div class="form-group">
                <label for="formGroupExampleInput2">Operator email</label>
                <input
                  type="email"
                  class="form-control"
                  id="useremaildel"
                  placeholder="Email"
                />
              </div>
              <div class="form-group">
                <label for="formGroupExampleInput2">Operator Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="userpassworddel"
                  placeholder="Password"
                />
              </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
            <button type="button" id="btndeleteuser" class="btn btn-primary">
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!----------------------------- Script's Before ----------------------------------------------->
    <script>
      var itm = document.getElementById("useritem");
      var cln = itm.cloneNode(true);
      document.getElementById("userslist").appendChild(cln);
      const demoClasses = document.querySelectorAll(".item-user");
      demoClasses[0].textContent = "Modified";

      $("#registeruser").click(function (){
        username = $("#useremail").val();
        password = $("#userpassword").val();
        const companymail = emailaux;
        const companyuser = uidaux;
        const companypass = passaux;
        var sum;
        var suma = firebase
          .database()
          .ref("users/" + companyuser + "/operators");
        suma.on("value", function (snapshot) {
          sum = parseInt(snapshot.val()) + 1;
        });
        firebase
          .database()
          .ref("users/" + companyuser)
          .update({ operators: sum });
        firebase
          .auth()
          .createUserWithEmailAndPassword(username, password)
          .then(function (user) {
            if (user) {
              uid = firebase.auth().currentUser.uid;
              console.log(uid);
              firebase
                .database()
                .ref("users/" + uid)
                .set({
                  email: $("#useremail").val(),
                  name: $("#opusername").val(),
                  password: $("#userpassword").val(),
                  type: "1",
                  companyid: companyuser,
                });
              firebase
                .auth()
                .signOut()
                .then(function () {
                  console.log("sing out success");
                })
                .catch(function (error) {
                  console.log(error);
                });
              Swal.fire({
                title: "Operator created",
                icon: "success",
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, New operator!",
              }).then((result) => {
                if (result.value) {
                  $("#staticBackdrop").modal("hide");
                }
              });
            }
          })
          .catch(function (error) {
            var errorCode = error.code;
            var errorMessage = error.message;
          });
        firebase
          .auth()
          .signInWithEmailAndPassword(companyuser, companypass)
          .catch(function (error) {
            var errorCode = error.code;
            var errorMessage = error.message;
          });
      });
      $("#btndeleteuser").click(function(){
        username = $("#useremaildel").val();
        password = $("#userpassworddel").val();
        const companymaild = emailaux;
        const companyuserd = uidaux;
        const companypassd = passaux;
        var sum1;
        var suma1 = firebase
          .database()
          .ref("users/" + companyuserd + "/operators");
        suma1.on("value", function (snapshot) {
          sum1 = parseInt(snapshot.val()) - 1;
        });
        firebase
          .database()
          .ref("users/" + companyuserd)
          .update({ operators: sum1 });
        firebase.auth().signInWithEmailAndPassword(username, password).then(function(user){
          uid = firebase.auth().currentUser.uid;
          console.log(uid);
          firebase.auth().currentUser.delete().then(function(){
            firebase.database().ref("users/" + uid).remove()
            firebase.auth().signInWithEmailAndPassword(companymaild,companypassd).then(function(){
              console.log(companyuserd);
              $("#deleteModal").modal("hide");
            });
          }).catch(function(){
            console.log("Error borrar usuario");
          });
        }).catch(function(){
          Swal.fire({
              icon: "error",
              title: "Usuario y/o contrase√±a son incorrectos",
            });
        });
      });
    </script>
  </body>
</html>
